# v0.3.0 Development Plan

**Version**: 0.3.0 (Performance First)
**Started**: 2025-11-07
**Target Completion**: TBD
**Branch**: refactor/step-3-modularization

---

## Version Goals

### Primary Objectives
1. **Latency Optimization**: 180ms → <90ms (50% reduction)
2. **Test Coverage**: 5% → 15% (3x increase)
3. **Code Quality**: 286 → <150 console.log statements
4. **Performance Tooling**: Add measurement instrumentation

### Success Criteria
- ✅ Version number unified across all files
- ✅ Test coverage > 15%
- ✅ At least 2 modules with comprehensive unit tests
- ⏳ Latency < 90ms (p95)
- ⏳ Performance bottlenecks identified and documented

---

## Task Breakdown

### Phase A: No Voice Testing Required ✅ In Progress

#### ✅ Task 1: Version Unification (COMPLETED)
**Status**: Done (2025-11-07)
**Commit**: `523fcea`

Files updated:
- package.json: 0.4.0 → 0.3.0
- README.md: Updated version, metrics, roadmap
- PROJECT_STATUS.md: Updated version and date
- CLAUDE.md: Added version in overview
- js/config/constants.js: @version 0.3.0
- js/config/app-config.js: @version 0.3.0

Documentation changes:
- Replaced "Phase X" with semantic versioning
- Updated performance metrics to reflect reality (180ms, not 8-15ms)
- Clarified v0.3.0 as "Performance First" milestone

---

#### ✅ Task 2: PitchDetector Unit Tests (COMPLETED)
**Status**: Done (2025-11-07)
**Commit**: `6978de1`

Results:
- **48 new tests** for PitchDetector module
- **100% passing** (67 total: 19 AppContainer + 48 PitchDetector)
- **Test coverage**: 5% → 10%
- **Bug found and fixed**: Empty buffer handling in calculateConfidence()

Test coverage breakdown:
```
Constructor & Init        : 2 tests
frequencyToNote()         : 7 tests (musical theory validation)
noteToFrequency()         : 6 tests (inverse conversion)
Round-trip conversions    : 2 tests (consistency)
getSmoothedPitch()        : 6 tests (median filtering)
calculateConfidence()     : 6 tests (RMS calculation)
quantizePitch()           : 4 tests (note snapping)
Configuration methods     : 6 tests (setters, reset)
getNoteRange()            : 5 tests (utility functions)
Edge cases & robustness   : 4 tests (extreme values)
```

Key validations:
- ✅ A4 = 440Hz (musical theory)
- ✅ Octave doubling (A3 = 220Hz, A4 = 440Hz, A5 = 880Hz)
- ✅ Cents calculation (sharp/flat detection)
- ✅ Median filter outlier rejection
- ✅ RMS confidence with voice range boost (80-800Hz)
- ✅ Input validation (null, empty, invalid)

---

#### ⏳ Task 3: AudioIO Unit Tests (IN PROGRESS)
**Status**: Next up
**Estimated tests**: 30-40

Planned coverage:
- Constructor and initialization
- Worklet mode setup and fallback
- ScriptProcessor fallback logic
- Message passing (worklet ↔ main thread)
- Error handling (permissions, browser compatibility)
- Configuration management
- Start/stop lifecycle
- Event emission

Test approach:
- Mock Web Audio API components (AudioContext, AudioWorkletNode)
- Test mode detection logic
- Test fallback mechanism
- Validate event callbacks

---

#### ⏳ Task 4: Code Quality - Reduce console.log
**Status**: Pending
**Current**: 286 statements
**Target**: <150 statements

Strategy:
1. Keep startup logs (browser detection, initialization)
2. Keep error logs (critical failures)
3. Remove debug logs (verbose state changes)
4. Consolidate repetitive logs
5. Use Logger utility consistently

Files to clean (priority):
1. js/main.js (likely highest count)
2. js/audio-io.js
3. js/pitch-detector.js
4. js/continuous-synth.js
5. js/expressive-features.js

---

#### ⏳ Task 5: Performance Instrumentation
**Status**: Pending

Add timing markers:
```javascript
// Example instrumentation
const t0 = performance.now();
// ... operation ...
const t1 = performance.now();
console.log(`[PERF] Operation took ${t1 - t0}ms`);
```

Target locations:
1. FFT computation (js/features/spectral-features.js)
2. Feature extraction pipeline (js/expressive-features.js)
3. Synthesizer processing (js/continuous-synth.js)
4. Worklet message handling (js/pitch-worklet.js)
5. YIN algorithm (if accessible)

Output format:
- Standardized `[PERF]` prefix
- Operation name
- Timing in milliseconds
- Optional: min/max/avg tracking

---

### Phase B: Voice Testing Required ⏸️ Waiting

#### ⏸️ Task 6: Baseline Latency Measurement
**Status**: Blocked (requires voice input)
**Prerequisites**: Microphone, quiet environment, user available

Steps:
1. Start application: `npm start`
2. Open browser: http://localhost:3000
3. Select instrument (e.g., Saxophone)
4. Click "Start Playing"
5. Sing/hum for 30 seconds
6. Execute in console: `window.app.getLatencyStats()`
7. Record metrics: min, max, avg, p50, p95
8. Document in PROJECT_STATUS.md

Expected baseline: ~180ms (current estimate)

---

#### ⏸️ Task 7: Verify AudioWorklet Mode
**Status**: Blocked (requires voice input)

Verification steps:
1. Start audio system
2. Execute: `window.container.get('audioIO').mode`
3. Expected: `'worklet'`
4. If `'script-processor'`: Investigate why Worklet failed

Fallback scenarios:
- Browser doesn't support AudioWorklet
- HTTPS/localhost requirement not met
- Worklet script failed to load

---

#### ⏸️ Task 8: Profile Latency Bottlenecks
**Status**: Blocked (requires Task 5 + Task 6)
**Prerequisites**: Instrumentation added, baseline measured

Analysis steps:
1. Review [PERF] logs from console
2. Identify slowest operations (>10ms)
3. Calculate percentage of total latency
4. Prioritize top 3 bottlenecks

Expected bottlenecks:
1. FFT computation (~20-40ms?)
2. Feature extraction pipeline (~10-20ms?)
3. Synthesizer processing (~5-10ms?)
4. ScriptProcessor buffer (46ms if fallback active)

---

#### ⏸️ Task 9: Optimize Primary Bottleneck
**Status**: Blocked (requires Task 8)
**Target**: 180ms → 80ms (55% reduction minimum)

Optimization strategies by bottleneck:

**If FFT is bottleneck:**
- Reduce FFT size (2048 → 1024 or 512)
- Reduce FFT frequency (every frame → every 2nd/3rd frame)
- Use Web Workers for FFT computation

**If Feature Extraction is bottleneck:**
- Disable non-critical features (brightness, breathiness)
- Simplify calculations
- Cache intermediate results

**If Synthesizer is bottleneck:**
- Reduce filter complexity
- Optimize Tone.js configuration
- Reduce polyphony if applicable

**If ScriptProcessor fallback:**
- Fix Worklet initialization
- Ensure browser compatibility
- Debug Worklet loading issues

---

#### ⏸️ Task 10: Update Documentation
**Status**: Blocked (requires all tasks)

Files to update:
1. PROJECT_STATUS.md
   - Update metrics (latency, test coverage)
   - Document optimizations applied
   - Record before/after measurements

2. README.md
   - Update performance section
   - Update v0.3.0 status

3. CLAUDE.md
   - Update performance targets
   - Document known bottlenecks
   - Update optimization guidelines

---

## Testing Strategy

### Unit Test Principles
1. **Real tests only** - Must be able to fail
2. **No fake frameworks** - Use Vitest only
3. **Test behavior, not implementation** - Focus on public API
4. **Edge cases matter** - Test null, undefined, empty, extreme values
5. **Fast execution** - All tests should run in <1 second

### Vitest Configuration
- **Mode**: CLI only (`npm test`)
- **Environment**: happy-dom (faster than jsdom)
- **Coverage**: v8 provider
- **Reports**: verbose mode for debugging

### Test File Structure
```
tests/
├── unit/
│   ├── app-container.test.js     (19 tests) ✅
│   ├── pitch-detector.test.js    (48 tests) ✅
│   └── audio-io.test.js          (TBD) ⏳
└── integration/
    └── (future integration tests)
```

---

## Development Principles

### Code Quality
- **Defensive programming** - Validate inputs, handle edge cases
- **Single responsibility** - One function, one purpose
- **Clear naming** - No abbreviations, descriptive names
- **Minimal comments** - Code should be self-documenting
- **Error handling** - Never fail silently

### Performance First
- **Measure before optimize** - No premature optimization
- **Profile with real data** - Use actual voice input
- **Benchmark all changes** - Before/after comparison
- **Focus on hotspots** - Optimize the 20% that matters

### Git Workflow
- **One feature per commit** - Atomic changes
- **Descriptive messages** - Explain why, not what
- **Run tests first** - `npm test` must pass
- **Push frequently** - Don't accumulate local commits

---

## Current Status Summary

| Task | Status | Tests Added | Coverage | Commit |
|------|--------|-------------|----------|--------|
| 1. Version Unification | ✅ Done | 0 | - | 523fcea |
| 2. PitchDetector Tests | ✅ Done | 48 | +5% | 6978de1 |
| 3. AudioIO Tests | ⏳ Next | TBD | +3-5% | - |
| 4. Reduce console.log | ⏳ Pending | 0 | - | - |
| 5. Add Instrumentation | ⏳ Pending | 0 | - | - |
| 6. Measure Latency | ⏸️ Blocked | 0 | - | - |
| 7. Verify Worklet | ⏸️ Blocked | 0 | - | - |
| 8. Profile Bottlenecks | ⏸️ Blocked | 0 | - | - |
| 9. Optimize Latency | ⏸️ Blocked | 0 | - | - |
| 10. Update Docs | ⏸️ Blocked | 0 | - | - |

**Overall Progress**: 20% (2/10 tasks completed)
**Test Coverage**: 10% (target 15%)
**Latency**: Not measured (baseline ~180ms estimated)

---

## Next Session Quick Start

```bash
# 1. Catchup on progress
/catchup

# 2. Check current status
npm test              # Should show 67 passing tests
git status            # Should be clean
git log --oneline -5  # Review recent commits

# 3. Continue with Task 3
# - Read js/audio-io.js
# - Write tests/unit/audio-io.test.js
# - Aim for 30-40 tests
# - Run npm test frequently
```

---

**Last Updated**: 2025-11-07
**Next Update**: After Task 3 completion
