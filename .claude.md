# Mambo Whistle - Claude Code 项目指南

**项目**: Mambo Whistle - 实时神经音频合成引擎
**技术栈**: Vanilla JavaScript (ES2022) + Web Audio API + Tone.js
**架构**: MVC + State-Driven + AudioWorklet

---

## 🚀 新会话启动流程（重要！）

### 每次新会话必须执行

1. **自动读取本文件** - Claude Code会自动读取 `.claude.md`（设计原则）
2. **主动读取上次会话** - 手动阅读 `docs/sessions/SESSION_LATEST.md`（上次工作内容）
3. **快速对齐上下文** - 了解项目最新状态和改动
4. **开始新工作** - 继续开发任务

### 会话工作流

```
新会话开始
    ↓
读取 .claude.md (本地，设计原则) ← 自动
    ↓
读取 docs/sessions/SESSION_LATEST.md (Git，上次工作) ← 主动
    ↓
快速对齐上下文
    ↓
开始新工作
    ↓
完成后更新 SESSION_LATEST.md ← 替换全部内容
    ↓
提交到 Git
```

### 文件职责说明

| 文件 | 用途 | Git追踪 | 更新频率 |
|------|------|---------|----------|
| `.claude.md` (本文件) | 永久设计原则和最佳实践 | ✅ 提交 | 很少（仅重大变更） |
| `docs/sessions/SESSION_LATEST.md` | 最新会话工作内容 | ✅ 提交 | **每次会话结束时完全替换** |

**重要**：`.claude.md` 现在提交到Git，原因：

1. 分支切换时不会丢失
2. 团队成员共享相同的设计原则
3. 作为项目核心知识库的一部分

### 推荐的会话开始提示词

```
请先阅读 docs/sessions/SESSION_LATEST.md 了解上一轮对话的工作内容，
然后告诉我项目当前状态，我们继续开发。
```

### 推荐的会话结束提示词

```
请总结本次会话的所有工作，用本次会话的全部工作内容完全替换
docs/sessions/SESSION_LATEST.md 的内容，然后提交到 Git。
```

---

## 核心设计原则

### 1. 性能优先于架构纯粹性

**原则**: 在性能关键路径（热路径）上，实用主义优先于完美的架构抽象。

**具体应用**:
- **音频热路径（60fps）**: 保留直接DOM操作，避免额外函数调用层
- **关键代码位置**: `js/main.js:256-261` - 7个高频DOM操作
- **验证**: 已实测过度抽象会导致音频检测不灵敏

```javascript
// ✅ 正确 - 直接操作，性能最优
this.ui.currentNote.textContent = `${note}${octave}`;
this.ui.currentFreq.textContent = `${frequency.toFixed(1)} Hz`;

// ❌ 错误 - 过度抽象导致性能下降
this.view.renderVisualizerMetrics({ note, octave, frequency });
```

**关键决策**: 实时音频处理（60fps）需要直接DOM操作，任何额外开销都会累积影响性能。

---

### 2. 渐进式改进策略

**原则**: 优先获得即时价值，避免一次性大规模重构的风险。

**TypeScript 迁移策略**:
- ✅ **宽松模式** (`strict: false`, `checkJs: false`)
- ✅ **仅类型检查** (`noEmit: true`)
- ✅ **智能提示优先** - 先获得IDE自动补全
- 🔮 **未来严格化** - 需要时逐步启用严格模式

**为什么不用严格模式？**
- 避免阻塞开发（不需要修复大量类型错误）
- 保持现有代码兼容
- 仍可获得90%的TypeScript价值

---

### 3. 单例模式用于重资源

**原则**: AudioContext、Canvas等重资源必须单例复用。

**关键实现**:
```javascript
// ✅ 正确 - 复用现有AudioContext
if (this.audioContext) {
    console.log('复用现有 AudioContext');
    if (this.audioContext.state === 'suspended') {
        await this.audioContext.resume();
    }
    return; // 不重新创建
}

// ❌ 错误 - 每次都创建新实例（内存泄漏）
this.audioContext = new AudioContext();
```

**影响范围**:
- `js/audio-io.js:460-470` - AudioContext管理
- 避免内存泄漏
- 保留设备选择配置

---

### 4. 诊断驱动的调试方法

**原则**: 详细日志比断点调试更适合异步/事件驱动的代码。

**日志规范**:
```javascript
// ✅ 结构化日志
console.log('[Main] Input device selected:', deviceId, {
    label: selectedLabel,
    isRunning: this.isRunning
});

// ✅ 状态对比日志
console.log('[Main] Device verification:', {
    requested: this.selectedInputId,
    applied: actualDeviceId
});

// ❌ 无信息日志
console.log('device selected');
```

**关键位置**:
- `js/main.js:534-537` - 设备选择日志
- `js/main.js:552-563` - 设备切换验证
- `js/main.js:752-768` - 活动设备状态捕获

---

### 5. 延迟权限请求原则

**原则**: 页面加载时不应触发麦克风/蓝牙权限请求。

**实现**:
```javascript
// ✅ 页面加载 - 跳过权限请求
this._refreshDeviceList({ skipPermissionRequest: true });

// ✅ 用户操作 - 主动请求权限
await navigator.mediaDevices.getUserMedia({ audio: true });
```

**影响**:
- 避免自动激活蓝牙设备
- 改善用户体验
- `js/main.js:215-217, 675-727`

---

## 软件工程最佳实践

### 1. 测试驱动开发（TDD）

**当前状态**: 235个单元测试 ✅
**测试框架**: Vitest v4.0.6
**覆盖率要求**: 核心模块 >80%

**测试金字塔**:
```
E2E测试（少量）        - 关键用户流程
  ↑
集成测试（适量）      - 模块交互
  ↑
单元测试（大量）      - 纯函数逻辑
```

**命令**:
```bash
npm test                 # 运行所有测试
npm run test:watch       # 监控模式
npm run test:coverage    # 覆盖率报告
```

---

### 2. 持续性能监控

**工具**: Lighthouse CI + GitHub Actions
**配置**: `lighthouserc.json`

**性能指标阈值**:
| 指标 | 目标值 | 级别 |
|------|--------|------|
| Performance Score | ≥90分 | error |
| FCP (首次内容绘制) | ≤2000ms | warn |
| LCP (最大内容绘制) | ≤2500ms | warn |
| CLS (累积布局偏移) | ≤0.1 | warn |
| TBT (总阻塞时间) | ≤300ms | warn |

**命令**:
```bash
npm run perf                 # 桌面端审计
npm run lighthouse:mobile    # 移动端审计
```

---

### 3. 模块化架构模式

**核心模式**: MVC + 依赖注入 + 状态管理

```
StateStore (Redux-like)
    ↓ dispatch(action)
AudioLoopController (Controller)
    ↓ updateUI()
MamboView (View)
```

**关键组件**:
- `js/core/app-container.js` - DI容器
- `js/ui/mambo-view.js` - View层抽象
- `js/core/audio-loop-controller.js` - 控制器
- `js/pitch-worklet.js` - AudioWorklet (60fps热路径)

**不要修改**:
- `js/main.js:256-261` - 音频热路径DOM操作

---

### 4. 配置驱动设计

**原则**: 所有可变参数应在配置文件中定义。

**配置文件**:
- `js/config/constants.js` - 全局常量
- `js/config/instrument-presets.js` - 乐器预设
- `js/config/app-config.js` - 应用配置

**好处**:
- 易于A/B测试
- 支持运行时切换
- 集中管理魔法数字

---

### 5. 向后兼容和降级策略

**Web Audio API 降级**:
```javascript
// AudioWorklet → ScriptProcessor → 错误提示
if (window.AudioWorklet) {
    // 现代浏览器路径
} else if (window.ScriptProcessorNode) {
    // 降级路径
} else {
    // 错误提示
}
```

**关键实现**:
- `js/audio-io.js` - 优雅降级逻辑
- 浏览器兼容性检测

---

## 关键技术决策记录

### 决策 1: 保留音频热路径的直接DOM操作

**日期**: 2025-11-22
**上下文**: 尝试将所有DOM操作抽象到View层
**决策**: 保留7个高频DOM操作在main.js中
**理由**:
- 实测抽象导致音频检测不灵敏
- 60fps热路径需要最小化函数调用开销
- 实用主义 > 架构纯粹性

**影响**:
- 性能: 无下降 ✅
- 可测试性: 保持 ✅
- 代码组织: 轻微妥协 ⚠️

**参考**: `REFACTOR_SUMMARY.md:116-148`

---

### 决策 2: TypeScript 宽松模式

**日期**: 2025-11-22
**上下文**: 需要IDE智能提示但不想修复大量类型错误
**决策**: 使用宽松TypeScript配置（`strict: false`）
**理由**:
- 即时价值（智能提示）
- 零阻塞（无需修复现有代码）
- 渐进迁移路径

**未来**: 可逐步启用严格检查

**参考**: `tsconfig.json`

---

### 决策 3: AudioContext 单例复用

**日期**: 2025-11-22
**上下文**: 每次restart创建新AudioContext导致内存泄漏
**决策**: 检查并复用现有AudioContext
**理由**:
- 避免内存泄漏
- 保留输出设备选择
- Web Audio API 最佳实践

**参考**: `js/audio-io.js:460-470`

---

## 常见陷阱和注意事项

### ⚠️ 不要修改的代码

**位置**: `js/main.js:256-261`
**原因**: 60fps音频热路径，已验证过度抽象会导致性能下降

### ⚠️ 设备选择测试要点

修改设备相关代码时，必须测试：
- ✅ 页面加载不触发蓝牙连接
- ✅ 运行时切换设备生效
- ✅ 重启后设备选择保留
- ✅ 控制台无警告日志

### ⚠️ AudioContext 管理

- ✅ 只在首次创建AudioContext
- ✅ 重启时复用现有实例
- ✅ 输出设备仅在初始化时设置

### ⚠️ 避免阻塞主线程

- 所有DSP逻辑在AudioWorklet中
- UI更新使用requestAnimationFrame
- 避免同步文件读取/网络请求

---

## 开发工作流

### 日常开发

```bash
# 1. 启动开发服务器
npm run dev

# 2. 监控测试（另一个终端）
npm run test:watch

# 3. 类型检查（可选）
npm run typecheck:watch
```

### 提交前检查

```bash
# 完整验证（类型检查 + 测试）
npm run validate

# 性能审计（可选，重要改动时）
npm run perf
```

### Git 提交规范

**Commit Message 格式**:
```
<type>(<scope>): <subject>

<body>

🤖 Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>
```

**Type 类型**:
- `feat`: 新功能
- `fix`: Bug修复
- `refactor`: 重构（无功能变化）
- `perf`: 性能优化
- `test`: 测试相关
- `docs`: 文档更新
- `chore`: 构建/工具配置

**示例**:
```bash
git commit -m "fix(audio): resolve AudioContext memory leak

- Reuse existing AudioContext on restart
- Preserve user device selection
- Add diagnostic logging

Test Results: 235/235 passing ✅

🤖 Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

## 项目结构速查

```
Adrian-UI-UX-1/
├── js/
│   ├── main.js                    # 主应用入口（包含7个热路径DOM操作）
│   ├── audio-io.js                # AudioContext管理
│   ├── pitch-worklet.js           # AudioWorklet (60fps热路径)
│   ├── core/
│   │   ├── app-container.js       # DI容器
│   │   ├── audio-loop-controller.js  # 音频循环控制器
│   │   └── music-scales.js        # 音乐理论
│   ├── ui/
│   │   └── mambo-view.js          # View层抽象
│   ├── managers/
│   │   ├── synth-manager.js       # 合成器管理
│   │   ├── visualizer-manager.js  # 可视化管理
│   │   └── device-manager.js      # 设备管理
│   ├── config/
│   │   ├── constants.js           # 全局常量
│   │   ├── instrument-presets.js  # 乐器预设
│   │   └── app-config.js          # 应用配置
│   └── types/
│       └── mambo-view.d.ts        # TypeScript类型定义
├── tests/                         # 测试文件 (235个测试)
├── docs/                          # 文档目录
│   ├── ARCHITECTURE_OVERVIEW.md   # 架构概览
│   ├── LATENCY_OPTIMIZATION.md    # 延迟优化
│   └── research/                  # 研究文档
├── .github/workflows/
│   └── ci.yml                     # CI/CD流水线
├── tsconfig.json                  # TypeScript配置（宽松模式）
├── lighthouserc.json              # Lighthouse CI配置
├── vitest.config.js               # Vitest配置
└── package.json                   # 项目元数据
```

---

## 调试技巧

### 1. 设备状态检查

**控制台日志搜索**:
```
[Main] Input device selected:      # 用户选择的设备
[Main] Capturing active device:    # 实际使用的设备
[AudioIO] 复用现有 AudioContext     # AudioContext复用
[Main] Skipping permission request # 跳过权限请求
```

### 2. localStorage 检查

```javascript
// 浏览器控制台
localStorage.getItem('mambo:lastInputDeviceId')
localStorage.getItem('mambo:lastOutputDeviceId')
localStorage.getItem('mambo:lastInputDeviceLabel')
localStorage.getItem('mambo:lastOutputDeviceLabel')
```

### 3. AudioContext 状态

```javascript
// 浏览器控制台
console.log(window.audioContext?.state)  // running / suspended / closed
console.log(window.audioContext?.sampleRate)
```

### 4. 性能分析

```javascript
// Chrome DevTools -> Performance
// 录制60fps音频处理时的性能

// 关注指标:
// - Main Thread 占用率 (<50%)
// - AudioWorklet 延迟 (<50ms)
// - Frame Rate (>55fps)
```

---

## 关键经验总结

### 1. 性能优先

> 热路径代码（60fps）不应过度抽象
> 实用主义 > 架构纯粹性

### 2. 渐进式改进

> TypeScript宽松模式先获得智能提示
> 性能监控自动化为持续优化打基础

### 3. 诊断驱动

> 详细的日志追踪快速定位Bug
> 验证实际设备 vs 请求设备

### 4. 单例重资源

> AudioContext 必须复用
> 避免内存泄漏和配置丢失

### 5. 延迟权限请求

> 页面加载不触发麦克风/蓝牙
> 改善用户体验

---

## 参考文档

**必读**:
- `docs/` - 技术文档目录
- `docs/ARCHITECTURE_OVERVIEW.md` - 架构详细说明
- `README.md` - 项目概览

**历史决策**:
- `docs/sessions/REFACTOR_SUMMARY.md` - 重构决策
- `docs/sessions/SESSION_SUMMARY.md` - 会话总结

**配置文件**:
- `tsconfig.json` - TypeScript配置
- `lighthouserc.json` - 性能监控
- `.github/workflows/ci.yml` - CI/CD

---

**最后更新**: 2025-11-22
**项目状态**: ✅ 稳定 (235/235 测试通过)
**当前分支**: `refactor/state-driven-ui-architecture`
